<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/vendor-layout :: layout(pageTitle=${pageTitle}, pageContent=~{::pageContent})}">
<body>
<div class="page-content" th:fragment="pageContent" th:with="currentPage='vendor-orders'">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0" th:text="${pageTitle}">Đơn #</h5>
        <a th:href="@{/vendor/orders}" class="btn btn-outline-secondary">Quay lại danh sách</a>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div><strong>Mã đơn:</strong> <span th:text="${order.id}"></span></div>
                            <div><strong>Ngày đặt:</strong>
                                <span th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm') : ''}"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div><strong>Trạng thái:</strong>
                                <span class="badge" th:text="${order.status}"
                                      th:classappend="${order.status=='DaGiao' ? 'bg-success' : (order.status=='DaHuy' ? 'bg-secondary' : 'bg-warning')}"></span>
                            </div>
                            <div><strong>Thanh toán:</strong>
                                <span class="badge" th:text="${order.paymentStatus}"
                                      th:classappend="${order.paymentStatus == 'DaThanhToan' ? 'bg-success' : 'bg-secondary'}"></span>
                                <span class="badge bg-light text-dark border ms-1" th:text="${order.paymentMethod == 'ChuyenKhoan' ? 'Chuyển khoản' : 'Tiền mặt'}"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Sản phẩm</h6>
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th class="text-center">Size</th>
                                <th class="text-center">SL</th>
                                <th class="text-end">Đơn giá</th>
                                <th class="text-end">Giảm dòng</th>
                                <th class="text-end">Thành tiền</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="it : ${items}">
                                <td>
                                    <div class="fw-semibold" th:text="${it.productName}"></div>
                                    <!-- Sugar/Ice from GhiChu -->
                                    <div class="mt-1" th:if="${it.note}">
                                        <span th:each="p : ${it.note != null ? it.note.split(';') : {}}"
                                              th:if="${#strings.contains(p,'Đường') or #strings.contains(p,'Đá')}"
                                              class="badge bg-light text-dark border me-1" th:text="${#strings.trim(p)}"></span>
                                    </div>
                                    <div class="small text-muted"
                                         th:if="${#maps.containsKey(toppings, it.id) and !#lists.isEmpty(toppings[it.id])}">
                                        <div class="mt-1">Topping:</div>
                                        <ul class="small mb-0">
                                            <li th:each="tp : ${toppings[it.id]}"
                                                th:text="${tp.toppingName + ' x' + tp.quantity + ' (' + #numbers.formatDecimal(tp.unitPrice,0,'COMMA',0,'POINT') + ' ₫) = ' + #numbers.formatDecimal(tp.total,0,'COMMA',0,'POINT') + ' ₫'}"></li>
                                        </ul>
                                    </div>
                                </td>
                                <td class="text-center" th:text="${it.sizeName}"></td>
                                <td class="text-center" th:text="${it.quantity}"></td>
                                <td class="text-end" th:text="${#numbers.formatDecimal(it.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                <td class="text-end" th:text="${#numbers.formatDecimal(it.lineDiscount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                <td class="text-end" th:text="${#numbers.formatDecimal(it.lineTotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(items)}">
                                <td colspan="6" class="text-center">Đơn hàng chưa có dòng sản phẩm.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title">Tổng kết</h6>
                    <div class="d-flex justify-content-between">
                        <span>Tổng thanh toán</span>
                        <strong th:text="${#numbers.formatDecimal(order.total, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></strong>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Xử lý đơn</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <a th:href="@{'/vendor/orders/' + ${order.id} + '/invoice'}" target="_blank" class="btn btn-outline-secondary">In hóa đơn</a>
                        <form th:action="@{'/vendor/orders/' + ${order.id} + '/advance'}" method="post">
                            <input type="hidden" name="from" value="detail">
                            <button class="btn btn-primary" type="submit"
                                    th:disabled="${(order.paymentMethod=='ChuyenKhoan' && order.paymentStatus!='DaThanhToan') || order.status=='DaGiao' || order.status=='DaHuy'}">Chuyển bước</button>
                        </form>
                        <form th:action="@{'/vendor/orders/' + ${order.id} + '/cancel'}" method="post" onsubmit="return confirm('Hủy đơn này?');">
                            <input type="hidden" name="from" value="detail">
                            <button class="btn btn-outline-danger" type="submit"
                                    th:disabled="${!(order.status=='ChoXuLy' || order.status=='DangPhaChe')}">Hủy</button>
                        </form>
                    </div>
                    <form class="mt-2" th:if="${order.paymentStatus!='DaThanhToan'}" th:action="@{'/vendor/orders/' + ${order.id} + '/mark-cash-paid'}" method="post" onsubmit="return confirm('Xác nhận đã thu tiền từ khách?');">
                        <input type="hidden" name="from" value="detail">
                        <button class="btn btn-success w-100" type="submit">Đã thu tiền</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>