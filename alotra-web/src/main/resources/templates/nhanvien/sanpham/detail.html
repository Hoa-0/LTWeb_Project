<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="nhanvien/layout :: layout(~{::content})">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết sản phẩm</title>
</head>
<body>
    <div th:fragment="content">
        <!-- Page Header -->
        <div class="page-header d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">Chi tiết sản phẩm</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a th:href="@{/NhanVien/dashboard}">Dashboard</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a th:href="@{/NhanVien/san-pham}">Quản lý Sản phẩm</a>
                        </li>
                        <li class="breadcrumb-item active">Chi tiết</li>
                    </ol>
                </nav>
            </div>
            <div>
                <a th:href="@{/NhanVien/san-pham/sua/{maSP}(maSP=${sanPham.maSP})}" 
                   class="btn btn-primary">
                    <i class="fas fa-edit me-2"></i>Sửa sản phẩm
                </a>
            </div>
        </div>

        <div class="row">
            <div class="col-xl-8">
                <!-- Product Information -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Thông tin sản phẩm</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <!-- Product Image -->
                                <div class="text-center mb-4">
                                    <img th:if="${sanPham.urlAnh != null and !sanPham.urlAnh.isEmpty()}" 
                                         th:src="${sanPham.urlAnh}" 
                                         alt="Product Image" 
                                         class="img-fluid rounded border"
                                         style="max-height: 300px;">
                                    <div th:unless="${sanPham.urlAnh != null and !sanPham.urlAnh.isEmpty()}" 
                                         class="bg-light rounded border d-flex align-items-center justify-content-center"
                                         style="height: 300px;">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-image fa-3x mb-3"></i>
                                            <p>Chưa có ảnh</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <!-- Product Details -->
                                <table class="table table-borderless">
                                    <tr>
                                        <td class="fw-semibold" width="150">Mã sản phẩm:</td>
                                        <td>
                                            <span class="badge bg-primary" th:text="'SP' + ${#strings.padLeft(sanPham.maSP.toString(), 3, '0')}">SP001</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Tên sản phẩm:</td>
                                        <td>
                                            <h5 class="mb-0" th:text="${sanPham.tenSP}">Tên sản phẩm</h5>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Danh mục:</td>
                                        <td>
                                            <span th:if="${sanPham.danhMuc != null}" 
                                                  class="badge bg-info" 
                                                  th:text="${sanPham.danhMuc.tenDM}">Danh mục</span>
                                            <span th:unless="${sanPham.danhMuc != null}" 
                                                  class="text-muted">Chưa phân loại</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Trạng thái:</td>
                                        <td>
                                            <span th:if="${sanPham.trangThai == 1}" class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Đang bán
                                            </span>
                                            <span th:unless="${sanPham.trangThai == 1}" class="badge bg-secondary">
                                                <i class="fas fa-pause me-1"></i>Ngừng bán
                                            </span>
                                        </td>
                                    </tr>
                                    <tr th:if="${sanPham.moTa != null and !sanPham.moTa.isEmpty()}">
                                        <td class="fw-semibold align-top">Mô tả:</td>
                                        <td th:text="${sanPham.moTa}">Mô tả sản phẩm</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Variants -->
                <div class="card" th:if="${sanPhamDTO.bienThes != null and !sanPhamDTO.bienThes.isEmpty()}">
                    <div class="card-header">
                        <h5 class="card-title">Biến thể sản phẩm</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Size</th>
                                        <th>Giá bán</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="bt : ${sanPhamDTO.bienThes}">
                                        <td>
                                            <span class="badge bg-outline-primary" th:text="${bt.tenSize}">Size M</span>
                                        </td>
                                        <td>
                                            <strong class="text-success" th:text="${#numbers.formatDecimal(bt.giaBan, 0, 'COMMA', 0, 'POINT')} + '₫'">50,000₫</strong>
                                        </td>
                                        <td>
                                            <span th:if="${bt.trangThai == 1}" class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Có sẵn
                                            </span>
                                            <span th:unless="${bt.trangThai == 1}" class="badge bg-secondary">
                                                <i class="fas fa-times me-1"></i>Hết hàng
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- No Variants Message -->
                <div class="card" th:if="${sanPhamDTO.bienThes == null or sanPhamDTO.bienThes.isEmpty()}">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Chưa có biến thể nào</h5>
                        <p class="text-muted">Sản phẩm này chưa có biến thể (size) nào được thiết lập.</p>
                        <a th:href="@{/NhanVien/san-pham/sua/{maSP}(maSP=${sanPham.maSP})}" 
                           class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Thêm biến thể
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-xl-4">
                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Thao tác nhanh</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a th:href="@{/NhanVien/san-pham/sua/{maSP}(maSP=${sanPham.maSP})}" 
                               class="btn btn-primary">
                                <i class="fas fa-edit me-2"></i>Sửa sản phẩm
                            </a>
                            
                            <button type="button" 
                                    class="btn btn-warning" 
                                    th:onclick="'toggleStatus(' + ${sanPham.maSP} + ', ' + ${sanPham.trangThai} + ')'"
                                    th:text="${sanPham.trangThai == 1 ? 'Ngừng bán' : 'Bán lại'}">
                                <i class="fas fa-toggle-on me-2"></i>Thay đổi trạng thái
                            </button>
                            
                            <hr>
                            
                            <button type="button" 
                                    class="btn btn-danger" 
                                    th:onclick="'confirmDelete(' + ${sanPham.maSP} + ', \'' + ${sanPham.tenSP} + '\')'">
                                <i class="fas fa-trash me-2"></i>Xóa sản phẩm
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product Stats -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Thống kê</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border rounded p-3">
                                    <h4 class="text-primary mb-1" th:text="${sanPhamDTO.bienThes != null ? sanPhamDTO.bienThes.size() : 0}">0</h4>
                                    <small class="text-muted">Biến thể</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-3">
                                    <h4 class="text-success mb-1">0</h4>
                                    <small class="text-muted">Đã bán</small>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="small text-muted">
                            <div class="d-flex justify-content-between">
                                <span>Giá thấp nhất:</span>
                                <strong th:if="${sanPhamDTO.bienThes != null and !sanPhamDTO.bienThes.isEmpty()}" 
                                        th:text="${#aggregates.min(sanPhamDTO.bienThes.![giaBan])} + '₫'">0₫</strong>
                                <strong th:unless="${sanPhamDTO.bienThes != null and !sanPhamDTO.bienThes.isEmpty()}">0₫</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Giá cao nhất:</span>
                                <strong th:if="${sanPhamDTO.bienThes != null and !sanPhamDTO.bienThes.isEmpty()}" 
                                        th:text="${#aggregates.max(sanPhamDTO.bienThes.![giaBan])} + '₫'">0₫</strong>
                                <strong th:unless="${sanPhamDTO.bienThes != null and !sanPhamDTO.bienThes.isEmpty()}">0₫</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Back Button -->
                <div class="card">
                    <div class="card-body">
                        <a th:href="@{/NhanVien/san-pham}" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận xóa sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa sản phẩm <strong id="deleteProductName"></strong>?</p>
                    <p class="text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Thao tác này không thể hoàn tác!
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <form id="deleteForm" method="post" class="d-inline">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-2"></i>Xóa
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmDelete(maSP, tenSP) {
            document.getElementById('deleteProductName').textContent = tenSP;
            document.getElementById('deleteForm').action = '/NhanVien/san-pham/xoa/' + maSP;
            
            var modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }
        
        function toggleStatus(maSP, currentStatus) {
            const action = currentStatus == 1 ? 'ngừng bán' : 'bán lại';
            if (confirm(`Bạn có chắc chắn muốn ${action} sản phẩm này?`)) {
                // Tạo form và submit để thay đổi trạng thái
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/NhanVien/san-pham/toggle-status/' + maSP;
                
                // Add CSRF token if needed
                const csrfToken = document.querySelector('meta[name="_csrf"]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = '_csrf';
                    csrfInput.value = csrfToken.getAttribute('content');
                    form.appendChild(csrfInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html>