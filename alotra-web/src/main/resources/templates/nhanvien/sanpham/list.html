<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{nhanvien/layout}">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Sản phẩm</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Page Header -->
        <div class="page-header d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">Quản lý Sản phẩm</h1>
                <p class="page-subtitle">Quản lý tất cả sản phẩm của shop</p>
            </div>
            <div>
                <a th:href="@{/NhanVien/san-pham/them}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Thêm sản phẩm mới
                </a>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Tổng sản phẩm</h5>
                                <h2 class="mb-0" th:text="${totalSanPham}">0</h2>
                            </div>
                            <i class="fas fa-box fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Đang bán</h5>
                                <h2 class="mb-0" th:text="${activeSanPham}">0</h2>
                            </div>
                            <i class="fas fa-check-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <form th:action="@{/NhanVien/san-pham}" method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="keyword" class="form-label">Tìm kiếm sản phẩm</label>
                        <input type="text" class="form-control" id="keyword" name="keyword" 
                               th:value="${keyword}" placeholder="Nhập tên sản phẩm...">
                    </div>
                    <div class="col-md-3">
                        <label for="maDM" class="form-label">Danh mục</label>
                        <select class="form-select" id="maDM" name="maDM">
                            <option value="">Tất cả danh mục</option>
                            <option th:each="dm : ${danhMucs}" 
                                    th:value="${dm.maDM}" 
                                    th:text="${dm.tenDM}"
                                    th:selected="${dm.maDM == selectedMaDM}">
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="pageSize" class="form-label">Hiển thị</label>
                        <select class="form-select" id="pageSize" name="size">
                            <option th:value="5" th:selected="${pageSize == 5}">5</option>
                            <option th:value="10" th:selected="${pageSize == 10}">10</option>
                            <option th:value="20" th:selected="${pageSize == 20}">20</option>
                            <option th:value="50" th:selected="${pageSize == 50}">50</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>Tìm kiếm
                        </button>
                        <a th:href="@{/NhanVien/san-pham}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Xóa bộ lọc
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Products Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Danh sách sản phẩm</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <a th:href="@{/NhanVien/san-pham(page=${currentPage}, size=${pageSize}, sortBy='maSP', sortDir=${sortBy == 'maSP' and sortDir == 'asc' ? 'desc' : 'asc'}, keyword=${keyword}, maDM=${selectedMaDM})}"
                                       class="text-decoration-none text-dark">
                                        Mã SP
                                        <i th:if="${sortBy == 'maSP'}" 
                                           th:class="${sortDir == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                        <i th:unless="${sortBy == 'maSP'}" class="fas fa-sort text-muted"></i>
                                    </a>
                                </th>
                                <th>Ảnh</th>
                                <th>
                                    <a th:href="@{/NhanVien/san-pham(page=${currentPage}, size=${pageSize}, sortBy='tenSP', sortDir=${sortBy == 'tenSP' and sortDir == 'asc' ? 'desc' : 'asc'}, keyword=${keyword}, maDM=${selectedMaDM})}"
                                       class="text-decoration-none text-dark">
                                        Tên sản phẩm
                                        <i th:if="${sortBy == 'tenSP'}" 
                                           th:class="${sortDir == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                        <i th:unless="${sortBy == 'tenSP'}" class="fas fa-sort text-muted"></i>
                                    </a>
                                </th>
                                <th>Danh mục</th>
                                <th>Trạng thái</th>
                                <th width="150">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${sanPhamPage.content.isEmpty()}">
                                <td colspan="6" class="text-center py-4">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <p class="text-muted mb-0">Không có sản phẩm nào</p>
                                </td>
                            </tr>
                            <tr th:each="sp : ${sanPhamPage.content}" th:unless="${sanPhamPage.content.isEmpty()}">
                                <td>
                                    <strong th:text="'SP' + ${sp.maSP}">SP001</strong>
                                </td>
                                <td>
                                    <img th:if="${sp.urlAnh != null and !sp.urlAnh.isEmpty()}" 
                                         th:src="${sp.urlAnh}" 
                                         alt="Product Image" 
                                         class="rounded" 
                                         style="width: 50px; height: 50px; object-fit: cover;">
                                    <div th:unless="${sp.urlAnh != null and !sp.urlAnh.isEmpty()}" 
                                         class="bg-light rounded d-flex align-items-center justify-content-center" 
                                         style="width: 50px; height: 50px;">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong th:text="${sp.tenSP}">Tên sản phẩm</strong>
                                        <br>
                                        <small class="text-muted" th:text="${#strings.abbreviate(sp.moTa, 50)}">Mô tả ngắn...</small>
                                    </div>
                                </td>
                                <td>
                                    <span th:if="${sp.danhMuc != null}" th:text="${sp.danhMuc.tenDM}">Danh mục</span>
                                    <span th:unless="${sp.danhMuc != null}" class="text-muted">N/A</span>
                                </td>
                                <td>
                                    <span th:if="${sp.trangThai == 1}" class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Đang bán
                                    </span>
                                    <span th:unless="${sp.trangThai == 1}" class="badge bg-secondary">
                                        <i class="fas fa-pause me-1"></i>Ngừng bán
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a th:href="@{/NhanVien/san-pham/xem/{maSP}(maSP=${sp.maSP})}" 
                                           class="btn btn-sm btn-outline-info" 
                                           title="Xem chi tiết">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a th:href="@{/NhanVien/san-pham/sua/{maSP}(maSP=${sp.maSP})}" 
                                           class="btn btn-sm btn-outline-warning" 
                                           title="Sửa">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-danger" 
                                                title="Xóa"
                                                th:data-id="${sp.maSP}"
                                                th:data-name="${sp.tenSP}"
                                                onclick="confirmDelete(this.dataset.id, this.dataset.name)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="card-footer" th:if="${sanPhamPage.totalPages > 1}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">
                            Hiển thị [[${sanPhamPage.numberOfElements}]] trong tổng số [[${sanPhamPage.totalElements}]] sản phẩm
                        </small>
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item" th:classappend="${!sanPhamPage.hasPrevious()} ? 'disabled'">
                                <a class="page-link" 
                                   th:href="@{/NhanVien/san-pham(page=${currentPage - 1}, size=${pageSize}, sortBy=${sortBy}, sortDir=${sortDir}, keyword=${keyword}, maDM=${selectedMaDM})}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            
                            <li th:each="pageNum : ${#numbers.sequence(0, sanPhamPage.totalPages - 1)}" 
                                class="page-item" 
                                th:classappend="${pageNum == currentPage} ? 'active'">
                                <a class="page-link" 
                                   th:href="@{/NhanVien/san-pham(page=${pageNum}, size=${pageSize}, sortBy=${sortBy}, sortDir=${sortDir}, keyword=${keyword}, maDM=${selectedMaDM})}"
                                   th:text="${pageNum + 1}">1</a>
                            </li>
                            
                            <li class="page-item" th:classappend="${!sanPhamPage.hasNext()} ? 'disabled'">
                                <a class="page-link" 
                                   th:href="@{/NhanVien/san-pham(page=${currentPage + 1}, size=${pageSize}, sortBy=${sortBy}, sortDir=${sortDir}, keyword=${keyword}, maDM=${selectedMaDM})}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận xóa sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa sản phẩm <strong id="deleteProductName"></strong>?</p>
                    <p class="text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Thao tác này không thể hoàn tác!
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <form id="deleteForm" method="post" class="d-inline">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-2"></i>Xóa
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmDelete(maSP, tenSP) {
            document.getElementById('deleteProductName').textContent = tenSP;
            document.getElementById('deleteForm').action = '/NhanVien/san-pham/xoa/' + maSP;
            
            var modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }
    </script>
</body>
</html>