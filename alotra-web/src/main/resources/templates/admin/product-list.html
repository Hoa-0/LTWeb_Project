<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title>Quản lý Sản phẩm</title>
    <style>
         /* CSS switch giữ nguyên */
         .switch { 
             position: relative; display: inline-block; width: 50px; height: 24px; 
         }
         .switch input { opacity: 0; width: 0; height: 0; }
         .slider { 
             position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
             background-color: #ccc; transition: .4s; border-radius: 24px; 
         }
         .slider:before { 
             position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; 
             background-color: white; transition: .4s; border-radius: 50%; 
         }
         input:checked + .slider { background-color: #2196F3; }
         input:checked + .slider:before { transform: translateX(26px); }
         /* Kết thúc CSS switch */
         
         .action-form { display: inline-block; margin: 0 2px; padding: 0; }
         /* CSS cho ảnh thumbnail */
         .product-thumbnail {
             width: 60px; 
             height: 60px;
             object-fit: cover; 
             border-radius: 8px; 
             border: 1px solid #dee2e6; 
         }
         /* Căn giữa nội dung trong cell */
         #productTable td, #productTable th {
             vertical-align: middle;
         }
    </style>
</head>
<body>

    <th:block layout:fragment="page_title">
        Quản lý Sản phẩm
    </th:block>
    
    <div layout:fragment="content">

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${successMessage}">Thông báo thành công</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${errorMessage}">Thông báo lỗi</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Danh sách Sản phẩm</h6>
                <form th:action="@{/admin/products}" method="get" class="d-flex">
                    <input class="form-control form-control-sm me-2" type="search" placeholder="Tìm theo tên..." 
                           name="keyword" th:value="${keyword}" aria-label="Search">
                    <button class="btn btn-outline-primary btn-sm" type="submit">Tìm</button>
                    <a th:href="@{/admin/products}" class="btn btn-outline-secondary btn-sm ms-1" th:if="${keyword}">Bỏ lọc</a>
                </form>
                <a th:href="@{/admin/products/add}" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus me-1"></i> Thêm Sản phẩm
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="productTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Mã SP</th>
                                <th>Ảnh</th>
                                <th>Tên Sản phẩm</th>
                                <th>Danh mục</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="prod : ${products}" th:classappend="${prod.isDeleted} ? 'table-secondary text-muted fst-italic'">
                                <td th:text="${prod.maSP}"></td>
                                <td class="text-center">
                                    <img th:src="${prod.urlAnh ?: '/images/placeholder.png'}" th:alt="${prod.tenSP}"
                                            class="product-thumbnail"/>
                                </td>
                                <td th:text="${prod.tenSP}"></td>
                                <td th:text="${prod.tenDM}"></td>
                                <td class="text-center align-middle">
                                    <form th:action="@{/admin/products/{id}/toggle-status(id=${prod.maSP})}" method="post" class="action-form">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <label class="switch m-0">
                                            <input type="checkbox" th:checked="${prod.trangThai == 1}" onchange="this.form.submit()" th:disabled="${prod.isDeleted}">
                                            <span class="slider"></span>
                                        </label>
                                    </form>
                                    <span th:if="${prod.isDeleted}" class="badge bg-dark ms-1">Đã xóa</span>
                                </td>
                                <td class="text-center align-middle">
                                    <th:block th:if="${!prod.isDeleted}">
                                        <a th:href="@{/admin/products/{id}/edit(id=${prod.maSP})}" class="btn btn-sm btn-outline-info me-1" title="Sửa">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form th:action="@{/admin/products/{id}/delete(id=${prod.maSP})}" method="post" class="action-form">
                                             <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                             <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa tạm thời"
                                                     onclick="return confirm('Bạn có chắc chắn muốn xóa tạm thời sản phẩm này?')">
                                                 <i class="fas fa-trash-alt"></i>
                                             </button>
                                        </form>
                                    </th:block>
                                    <th:block th:if="${prod.isDeleted}">
                                        <form th:action="@{/admin/products/{id}/restore(id=${prod.maSP})}" method="post" class="action-form">
                                             <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                             <button type="submit" class="btn btn-sm btn-outline-success me-1" title="Khôi phục"
                                                     onclick="return confirm('Bạn có chắc chắn muốn khôi phục sản phẩm này?')">
                                                 <i class="fas fa-undo"></i>
                                             </button>
                                        </form>
                                        <form th:action="@{/admin/products/{id}/delete-permanently(id=${prod.maSP})}" method="post" class="action-form">
                                             <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                             <button type="submit" class="btn btn-sm btn-danger" title="Xóa vĩnh viễn"
                                                     onclick="return confirm('!!! CẢNH BÁO !!!\nBạn có chắc chắn muốn XÓA VĨNH VIỄN sản phẩm này?\nHành động này không thể hoàn tác và có thể ảnh hưởng đến các đơn hàng cũ.')">
                                                 <i class="fas fa-skull-crossbones"></i>
                                             </button>
                                        </form>
                                    </th:block>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(products)}">
                                 <td colspan="6" class="text-center text-muted">Không tìm thấy sản phẩm nào.</td>
                             </tr>
                        </tbody>
                    </table>
                </div>

                <div th:if="${productsPage.totalPages > 1}" class="d-flex justify-content-center mt-3">
                    <nav aria-label="Product navigation">
                        <ul class="pagination pagination-sm">
                            <li class="page-item" th:classappend="${productsPage.number == 0} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/products(keyword=${keyword}, size=${productsPage.size}, page=${productsPage.number - 1})}" tabindex="-1">Trước</a>
                            </li>
                            <li class="page-item" th:each="i : ${pageNumbers}" th:classappend="${i == productsPage.number} ? 'active'">
                                <a class="page-link" th:href="@{/admin/products(keyword=${keyword}, size=${productsPage.size}, page=${i})}" th:text="${i + 1}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${productsPage.number + 1 == productsPage.totalPages} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/products(keyword=${keyword}, size=${productsPage.size}, page=${productsPage.number + 1})}">Sau</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div> <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function() {
                // ĐÃ XÓA KHỞI TẠO DATATABLES VÌ DÙNG PHÂN TRANG THỦ CÔNG
                
                // Tự động tắt thông báo
                setTimeout(function() { $('.alert').alert('close'); }, 5000);
            });
            /*]]>*/
        </script>
    </th:block>

</body>
</html>