<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/admin-layout :: layout(pageTitle='Tổng quan', pageContent=~{::pageContent})}">

<body>
<div class="page-content" th:fragment="pageContent" th:with="currentPage='dashboard'">
    <div class="row g-3 mb-3">
        <div class="col-6 col-md-4 col-lg-2">
            <div class="kpi-card gradient-green h-100">
                <div class="kpi-label">Doanh thu</div>
                <div class="kpi-value" th:text="${#numbers.formatDecimal(stats.totalRevenue,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</div>
                <div class="kpi-sub">Đã giao & thanh toán</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="kpi-card gradient-blue h-100">
                <div class="kpi-label">Đơn hàng</div>
                <div class="kpi-value" th:text="${stats.totalOrders}">0</div>
                <div class="kpi-sub">Tổng phát sinh</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="kpi-card gradient-orange h-100">
                <div class="kpi-label">Khách hàng</div>
                <div class="kpi-value" th:text="${stats.totalCustomers}">0</div>
                <div class="kpi-sub">Đã đăng ký</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="kpi-card gradient-purple h-100">
                <div class="kpi-label">Sản phẩm</div>
                <div class="kpi-value" th:text="${stats.totalProducts}">0</div>
                <div class="kpi-sub">Đang hoạt động</div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="kpi-card gradient-teal h-100">
                <div class="kpi-label">Đánh giá</div>
                <div class="kpi-value" th:text="${stats.totalReviews}">0</div>
                <div class="kpi-sub">
                    <span th:text="${#numbers.formatDecimal(stats.avgStars,1,'COMMA',1,'POINT')} + ' ★'">0.0 ★</span>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="kpi-card gradient-gray h-100">
                <div class="kpi-label">Tỷ lệ đánh giá</div>
                <div class="kpi-value" th:text="${stats.avgStars != null ? #numbers.formatDecimal(stats.avgStars,1,'COMMA',1,'POINT') : '0'}">0</div>
                <div class="kpi-sub">Điểm trung bình</div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">Doanh thu 14 ngày gần nhất</span>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="140"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header fw-semibold">Trạng thái đơn hàng</div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-xl-6">
            <div class="card h-100">
                <div class="card-header fw-semibold">Top sản phẩm</div>
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 align-middle">
                        <thead><tr><th>#</th><th>Sản phẩm</th><th class="text-end">SL</th><th class="text-end">Doanh thu</th></tr></thead>
                        <tbody>
                        <tr th:each="p,iter : ${stats.topProducts}">
                            <td th:text="${iter.index+1}"></td>
                            <td th:text="${p['name']}"></td>
                            <td class="text-end" th:text="${p['qty']}"></td>
                            <td class="text-end" th:text="${#numbers.formatDecimal(p['amount'],0,'COMMA',0,'POINT')} + ' ₫'"></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(stats.topProducts)}"><td colspan="4" class="text-center text-muted">Chưa có dữ liệu.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card h-100">
                <div class="card-header fw-semibold">Top khách hàng</div>
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 align-middle">
                        <thead><tr><th>#</th><th>Khách hàng</th><th class="text-end">Đơn</th><th class="text-end">Chi tiêu</th></tr></thead>
                        <tbody>
                        <tr th:each="c,iter : ${stats.topCustomers}">
                            <td th:text="${iter.index+1}"></td>
                            <td th:text="${c['name']}"></td>
                            <td class="text-end" th:text="${c['orders']}"></td>
                            <td class="text-end" th:text="${#numbers.formatDecimal(c['spend'],0,'COMMA',0,'POINT')} + ' ₫'"></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(stats.topCustomers)}"><td colspan="4" class="text-center text-muted">Chưa có dữ liệu.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header fw-semibold">Doanh thu theo danh mục</div>
                <div class="card-body">
                    <canvas id="categoryChart" height="110"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const revenueDaily = /*[[${stats.revenueDaily}]]*/ [];
        const orderStatus = /*[[${stats.orderStatus}]]*/ [];
        const categorySales = /*[[${stats.categorySales}]]*/ [];
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        (function(){
            // Revenue line
            const revLabels = revenueDaily.map(r=>r.date);
            const revData = revenueDaily.map(r=> Number(r.total));
            new Chart(document.getElementById('revenueChart'), {
                type:'line',
                data:{ labels:revLabels, datasets:[{ label:'Doanh thu (₫)', data:revData, tension:.35, fill:true, borderColor:'#198754', backgroundColor:'rgba(25,135,84,.15)', pointRadius:3}]},
                options:{ plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:v=> v.toLocaleString('vi-VN')}}}}
            });
            // Status donut
            const stLabels = orderStatus.map(s=>s.status||'N/A');
            const stVals = orderStatus.map(s=>s.count);
            new Chart(document.getElementById('statusChart'), { type:'doughnut', data:{ labels:stLabels, datasets:[{ data:stVals, backgroundColor:['#0d6efd','#ffc107','#dc3545','#198754','#6f42c1','#20c997']}]}, options:{ plugins:{legend:{position:'bottom'}}, cutout:'55%'}});
            // Category bar
            const catLabels = categorySales.map(c=>c.name||'Không rõ');
            const catVals = categorySales.map(c=> Number(c.amount));
            new Chart(document.getElementById('categoryChart'), { type:'bar', data:{ labels:catLabels, datasets:[{ label:'Doanh thu (₫)', data:catVals, backgroundColor:'#6610f2'}]}, options:{ plugins:{legend:{display:false}}, scales:{ y:{ ticks:{ callback:v=> v.toLocaleString('vi-VN')}} }}});
        })();
    </script>
</div>
</body>
</html>